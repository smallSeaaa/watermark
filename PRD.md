# 图片日期水印工具 - 产品需求文档

## 1. 产品概述

图片日期水印工具是一个支持命令行和图形界面的应用程序，用于自动为图片添加基于拍摄日期的水印。该工具能够从图片的 EXIF 信息中提取拍摄日期，并以可自定义的方式添加到图片上，适用于需要为大量图片添加时间戳标记的场景。

## 2. 产品功能

### 2.1 核心功能

- **日期水印生成**：从图片的 EXIF 信息中提取拍摄日期，并以"YYYY-MM-DD"格式作为水印文本
- **备选日期源**：当图片没有 EXIF 日期信息时，自动使用文件修改时间作为备选
- **批量处理**：支持处理单个图片文件或整个目录下的所有图片
- **自动输出管理**：自动创建输出目录并保存带水印的图片

### 2.2 自定义选项

- **字体大小**：允许用户自定义水印文本的字体大小
- **文本颜色**：允许用户自定义水印文本的颜色
- **背景颜色**：允许用户自定义水印背景的颜色
- **水印位置**：支持多种水印位置选项，包括：
  - 四角位置：top-left、top-right、bottom-left、bottom-right
  - 边缘中心：top、bottom、left、right
  - 图片中心：center
- **JPEG质量**：允许用户在导出JPEG格式时设置质量参数（0-100范围）
- **图片尺寸调整**：支持多种图片缩放方式，包括：
  - 原始尺寸：保持图片原有尺寸
  - 等比例缩放：按指定宽度或高度等比例缩放
  - 调整宽度：保持宽高比，只指定宽度
  - 调整高度：保持宽高比，只指定高度

## 3. 技术实现

### 3.1 依赖库

- Python 3.6+：核心编程语言
- PIL (Pillow)：图像处理和水印添加
- exifread：读取图片 EXIF 信息
- datetime：日期时间处理
- argparse：命令行参数解析
- tkinter：GUI 界面构建
- tkinterdnd2：拖放功能支持（GUI 版本）

### 3.2 核心模块

#### 3.2.1 日期提取模块 (`get_exif_datetime`)

- 尝试从图片的 EXIF 信息中读取多种日期时间标签
- 支持的标签优先级：DateTimeOriginal > DateTimeDigitized > Image DateTime
- 将原始日期时间字符串解析为标准格式
- 错误处理和异常捕获

#### 3.2.2 颜色解析模块 (`parse_color`)

- 支持多种颜色格式：
  - 预定义颜色名称（black、white、red 等）
  - 十六进制格式（#RRGGBB 或#RRGGBBAA）
  - RGB/RGBA 元组格式
- 格式验证和边界检查
- 默认值处理

#### 3.2.3 水印添加模块 (`add_watermark_to_image`)

- 图片打开和处理
- 水印文本和字体设置
- 多位置水印坐标计算
- 水印背景和文本渲染
- 图片保存和错误处理

#### 3.2.4 目录处理模块 (`process_directory`)

- 路径类型判断（文件或目录）
- 输出目录创建逻辑
- 支持的图片格式过滤
- 批量文件遍历和处理

#### 3.2.5 命令行界面模块

- 参数解析和验证
- 默认参数设置
- 用户帮助信息
- 程序入口和流程控制

#### 3.2.6 图形用户界面模块

- 主窗口和布局设计（初始尺寸1100x900，最小尺寸1000x800）
- 图片导入和管理功能
- 参数设置界面
- 拖放功能支持
- 处理进度显示
- 结果反馈和统计
- JPEG质量调节控制
- 图片尺寸调整功能
- 自适应布局设计，确保所有控件清晰可见

## 4. 使用流程

### 4.1 基本使用流程

1. 用户通过命令行指定图片或目录路径
2. 程序读取图片并尝试提取 EXIF 日期信息
3. 程序为图片添加日期水印
4. 程序将处理后的图片保存到指定输出目录
5. 程序输出处理结果信息

### 4.2 目录处理逻辑

当用户输入为目录路径时：

1. 程序在该目录下创建`原目录名_watermark`子目录
2. 程序遍历该目录下所有支持格式的图片文件
3. 程序为每个图片文件添加水印并保存到子目录中
4. 处理后的文件名格式为`watermarked_原文件名`

## 5. 命令行接口

```bash
python watermark.py 图片路径 [--font-size 字体大小] [--text-color 文本颜色] [--bg-color 背景颜色] [--position 位置]
```

### 5.1 必选参数

- `image_path`：图片文件路径或包含图片的目录路径

### 5.2 可选参数

- `--font-size`：设置水印字体大小（默认值：30）
- `--text-color`：设置水印文本颜色（支持多种格式，默认值：black）
- `--bg-color`：设置水印背景颜色（支持多种格式，默认值：white）
- `--position`：设置水印位置（可选值：top-left、top-right、bottom-left、bottom-right、center、top、bottom、left、right，默认值：bottom-right）

## 6. 颜色格式规范

### 6.1 预定义颜色名称

| 颜色名称 | RGB 值          |
| -------- | --------------- |
| black    | (0, 0, 0)       |
| white    | (255, 255, 255) |
| red      | (255, 0, 0)     |
| green    | (0, 255, 0)     |
| blue     | (0, 0, 255)     |
| yellow   | (255, 255, 0)   |
| cyan     | (0, 255, 255)   |
| magenta  | (255, 0, 255)   |

### 6.2 十六进制格式

- 标准格式：`#RRGGBB`（例如：`#FF0000` 表示红色）
- 带透明度格式：`#RRGGBBAA`（例如：`#FF000080` 表示半透明红色）

### 6.3 RGB/RGBA 元组格式

- RGB 格式：`(r,g,b)`（例如：`(255,0,0)` 表示红色）
- RGBA 格式：`(r,g,b,a)`（例如：`(255,0,0,128)` 表示半透明红色）

## 7. 支持的图片格式

- JPG (.jpg, .jpeg)
- PNG (.png)
- BMP (.bmp)
- GIF (.gif)
- TIFF (.tiff)

## 8. 输出规范

- 输出目录：在原图片所在目录下创建`原目录名_watermark`子目录
- 输出文件名：`watermarked_原文件名`
- 输出格式：保持与原图片相同的格式
- 输出信息：处理过程中输出详细的日志信息，包括成功和失败记录

## 9. 错误处理

- 路径不存在：提示错误信息并退出
- EXIF 信息读取失败：使用文件修改时间作为备选
- 图片处理失败：输出错误信息并继续处理其他图片
- 颜色解析失败：使用默认黑色并提示警告信息
- 字体加载失败：使用默认字体并继续处理

## 10. 版本历史

### 版本 2.0

- 添加图形用户界面（GUI）版本
- 实现拖放功能支持，用户可直接拖拽图片到窗口
- 支持单张或批量导入图片
- 图形化设置水印参数
- 支持自定义输出文件夹和命名规则
- 显示处理进度和结果统计

### 版本 1.0

- 完成基本功能实现
- 支持从 EXIF 信息提取拍摄日期
- 支持自定义字体大小、颜色和位置
- 支持批量处理图片目录
- 支持 8 种水印位置选项
- 提供详细的使用文档
